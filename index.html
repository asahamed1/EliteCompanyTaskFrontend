<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Account Statement</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    body {
      background-color: #f5f6fa;
      padding: 30px;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    .card {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    .table thead {
      background-color: #0d6efd;
      color: white;
    }

    .totals-box {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .loading-spinner {
      display: none;
    }
  </style>
</head>

<body>
  <div id="loadingOverlay"
    class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center"
    style="z-index: 1050;">
    <div class="spinner-border text-light" style="width: 4rem; height: 4rem;" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <div class="container">
    <h2 class="mb-4 text-center text-primary">Account Statement</h2>
<div id="errorDiv" style="color:red;"></div>
    <!-- Filters -->
    <div class="card mb-4 p-3">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Account Name</label>
          <select style="width: 200px;" class="accounts_dropdown" name="state">

          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">From Date</label>
          <input type="date" class="form-control" id="fromDate">
        </div>
        <div class="col-md-3">
          <label class="form-label">To Date</label>
          <input type="date" class="form-control" id="toDate">
        </div>
        <div class="col-md-2 text-end">
          <button class="btn btn-primary w-100" id="searchBtn" onclick="Search()">Search</button>
        </div>
      </div>
      <div class="mt-3 d-flex gap-2 justify-content-end">
        <button class="btn btn-secondary" id="printBtn" onclick="exportToPDF()">Print</button>
        <button class="btn btn-success" id="exportBtn" onclick="exportToexcel()">Export Excel</button>
        <button class="btn btn-warning" id="yearBtn" onclick="PrintThisYearReport()">Print (Year)</button>
      </div>
    </div>

    <!-- Table -->
    <div class="card p-3 mb-3">
      <div class="table-responsive">
        <table id="balance_history_table" class="table table-bordered table-striped align-middle text-center">
          <thead>
            <tr>
              <th>Account ID</th>
              <th>Account Name</th>
              <th>Previous Balance</th>
              <th>Debit</th>
              <th>Credit</th>
              <th>Final Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="statementTableBody">
            <!-- dynamic rows -->
          </tbody>
          <tfoot id="statementTableFooter">
            <tr class="fw-bold">
              <td></td>
              <td></td>
              <td></td>
              <td id="totalDebit"></td>
              <td id="totalCredit"></td>
              <td id="totalFinal"></td>
              <td></td>

            </tr>
          </tfoot>
        </table>
      </div>
    </div>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">History Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalBody">
        Loading...
      </div>
    </div>
  </div>
</div>






    <!-- Scripts -->

    <script>
      let backendUrl = "http://localhost:5262/api/"
      $(document).on("click", ".openModalBtn", function () {
  const historyId = $(this).data("historyid"); // âœ… get ID from clicked button
  $("#modalBody").html("Loading...");

  const modal = new bootstrap.Modal(document.getElementById("myModal"));
  modal.show();

  $.ajax({
    url: backendUrl + "Account/GetHistoryDetails",
    type: "GET",
    data: { id: historyId },
    success: function (data) {
      $("#modalBody").html(`
      <p>creditor</p>
      <p>${data.result.creditor}</p>
      <p>debtor</p>
      <p>${data.result.debtor}</p>
      <p>previous Balance</p>
      <p>${data.result.previousBalance}</p>
      <p>new Balance</p>
      <p>${data.result.newBalance}</p>
      <p>remarks</p>
      <p>${data.result.remarks}</p>
      <p>Date</p>
      <p>${data.result.date}</p>
      `);
    },
    error: function (xhr) {
      $("#modalBody").html("<span class='text-danger'>Failed to load history details.</span>");
      console.error(xhr);
    }
  });
});

      $(document).ready(function () {
        // optimazied account name to be pagantied 
        $('.accounts_dropdown').select2({
          ajax: {
            url: backendUrl + 'Account/GetAccountsList',
            data: function (params) {
              var query = {
                query: params.term,
                page: params.page || 1,
                pageSize: 20
              }


              return query;
            },
            processResults: function (data) {
              console.log(data)
              return {
                results: data.result.accountslist.map(x => ({
                  id: x.id,
                  text: x.name
                })),
                pagination: {
                  more: data.result.hasMore
                }
              };
            }
          }
        });
        // HandelAUto search 

      });

      function showLoader() {
        document.getElementById("loadingOverlay").classList.remove("d-none");
      }

      function hideLoader() {
        document.getElementById("loadingOverlay").classList.add("d-none");
      }
      function Search() {
         $("#errorDiv").html("");
        showLoader();

        let balanceId = $('.accounts_dropdown').val();
        let fromDate = document.getElementById("fromDate").value;
        let toDate = document.getElementById("toDate").value;
        let data = {
          "accountId": balanceId == '' ? null : balanceId,
          "fromDate": fromDate == '' ? null : fromDate,
          "toDate": toDate == '' ? null : toDate
        }

        $.ajax({
          url: backendUrl + 'Account/GetAccountBalanceHistory',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data),
          success: function (response) {
            hideLoader();
            let balanceHistoryTable = $("#balance_history_table")
            balanceHistoryTable.empty();
            balanceHistoryTable.append(`<thead>
            <tr>
              <th>Account ID</th>
              <th>Account Name</th>
              <th>Previous Balance</th>
              <th>Debit</th>
              <th>Credit</th>
              <th>Final Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="statementTableBody">
            <!-- dynamic rows -->
          </tbody>`)
            if (response.result.length > 0) {


              console.log(balanceHistoryTable)
              let balanceHistoryTBody = $("#statementTableBody")
              console.log(balanceHistoryTBody)
              $.each(response.result, function (index, item) {
                console.log(item)
                var row = `
            <tr>
              <td>${item.accountId}</td>
              <td>${item.accountName}</td>
              <td>${item.previousBalance ?? 0}</td>
              <td>${item.debitAmount ?? 0}</td>
              <td>${item.creditAmount ?? 0}</td>
              <td>${item.finalBalance ?? 0}</td>
               <td>
        <button class="btn btn-info btn-sm openModalBtn" data-historyid="${item.balanceHistoryId}">
          View
        </button>
      </td>
            </tr>`;
                balanceHistoryTBody.append(row);
              })
              balanceHistoryTable.append(`<tfoot id = "statementTableFooter">
            <tr class="fw-bold">
              <td  ></td>
              <td></td>
              <td></td>
              <td id="totalDebit">${response.result[0].totalDebit}</td>
              <td id="totalCredit">${response.result[0].totalCredit}</td>
              <td id="totalFinal">${response.result[0].totalFinalBalance}</td>
              <td></td>
              
            </tr>
          </tfoot>`)

            }
          },
          error: function (xhr, status, error) {
            hideLoader();
                  if (xhr.status === 400) {
            const errors = xhr.responseJSON;
               console.log(errors.errors)
            let errorMessages = "";
             let html = "";
        for (let key in errors.errors) {
            html += errors.errors[key] + "<br>";
        }
        $("#errorDiv").html(html);
    }
          }
        });
      }
      function exportToexcel() {
           $("#errorDiv").html("");
        showLoader();

        let balanceId = $('.accounts_dropdown').val();
        let fromDate = document.getElementById("fromDate").value;
        let toDate = document.getElementById("toDate").value;
        let data = {
          "accountId": balanceId == '' ? null : balanceId,
          "fromDate": fromDate == '' ? null : fromDate,
          "toDate": toDate == '' ? null : toDate
        }

        $.ajax({
          url: backendUrl + 'Account/ExportBalanceHistory',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data),
          xhrFields: { responseType: 'blob' },
          success: function (response, status, xhr) {
            console.log(response)
            const blob = new Blob([response], { type: xhr.getResponseHeader('Content-Type') });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);

            // Try to get filename from the Content-Disposition header
            const disposition = xhr.getResponseHeader('Content-Disposition');
            let fileName = "report.xlsx";
            if (disposition && disposition.indexOf('filename=') !== -1) {
              fileName = disposition.split('filename=')[1].trim().replace(/['"]/g, '');
            }

            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            hideLoader();



          },
         error: function (xhr, status, error) {
            hideLoader();
                 
        $("#errorDiv").html("please select required field");
    
          }
        });
      }
      function exportToPDF() {
           $("#errorDiv").html("");
        showLoader();

        let balanceId = $('.accounts_dropdown').val();
        let fromDate = document.getElementById("fromDate").value;
        let toDate = document.getElementById("toDate").value;
        let data = {
          "accountId": balanceId == '' ? null : balanceId,
          "fromDate": fromDate == '' ? null : fromDate,
          "toDate": toDate == '' ? null : toDate
        }
        GetREportAsPDF(data);

      }
      function PrintThisYearReport() {
          $("#errorDiv").html("");

        let balanceId = $('.accounts_dropdown').val();
        console.log(balanceId)
        if (balanceId == null ) {
          alert("please select account");
          return;
        }
         showLoader();
        const now = new Date();
        const currentYear = now.getFullYear();
        console.log(currentYear)
        let firstDay = new Date(currentYear, 0, 1)
        console.log(firstDay)
        firstDay = firstDay.toLocaleDateString('en-CA');;

        let toDate = new Date().toLocaleDateString('en-CA');
        let data = {
          "accountId": balanceId,
          "fromDate": firstDay,
          "toDate": toDate
        }
        GetREportAsPDF(data);

      }
      function GetREportAsPDF(data) {
        $.ajax({
          url: backendUrl + 'Account/ExportBalanceHistoryAsPdf',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data),
          xhrFields: { responseType: 'blob' },
          success: function (response, status, xhr) {
            console.log(response)
            const blob = new Blob([response], { type: xhr.getResponseHeader('Content-Type') });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);

            // Try to get filename from the Content-Disposition header
            const disposition = xhr.getResponseHeader('Content-Disposition');
            let fileName = "report.pdf";
            if (disposition && disposition.indexOf('filename=') !== -1) {
              fileName = disposition.split('filename=')[1].trim().replace(/['"]/g, '');
            }

            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            hideLoader();



          },
          error: function (xhr, status, error) {
            hideLoader();
                 
        $("#errorDiv").html("please select required field");
    
          }
        });
      }
    </script>
</body>

</html>